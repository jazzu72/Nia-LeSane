#!/bin/bash
# ================================================================
# HOUSE OF JAZZU HQ - Quick Setup Script
# Automates environment configuration with your Telegram credentials
# ================================================================

set -e  # Exit on error

echo "ðŸ›ï¸  HOUSE OF JAZZU HQ - Quick Setup"
echo "===================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if .env.production already exists
if [ -f .env.production ]; then
    echo -e "${YELLOW}âš ï¸  .env.production already exists!${NC}"
    read -p "Overwrite? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Cancelled."
        exit 0
    fi
    mv .env.production .env.production.backup
    echo -e "${GREEN}âœ… Backed up to .env.production.backup${NC}"
fi

echo ""
echo "ðŸ” Generating secure secrets..."
echo ""

# Generate secrets
VAULT_KEY=$(openssl rand -base64 32)
POSTGRES_PASSWORD=$(openssl rand -base64 24)
REDIS_PASSWORD=$(openssl rand -base64 24)
GRAFANA_PASSWORD=$(openssl rand -base64 16)

echo -e "${GREEN}âœ… Generated vault master key${NC}"
echo -e "${GREEN}âœ… Generated database passwords${NC}"
echo -e "${GREEN}âœ… Generated monitoring passwords${NC}"

# Prompt for required information
echo ""
echo "ðŸ“ Please provide the following information:"
echo ""

# Domain
read -p "Your domain name (e.g., houseofjazzu.com): " DOMAIN
if [ -z "$DOMAIN" ]; then
    DOMAIN="houseofjazzu.com"
    echo -e "${YELLOW}Using default: $DOMAIN${NC}"
fi

# Stripe API Key
echo ""
echo "Get Stripe keys from: https://dashboard.stripe.com/test/apikeys"
read -p "Stripe Secret Key (or press Enter to skip): " STRIPE_KEY
if [ -z "$STRIPE_KEY" ]; then
    STRIPE_KEY="sk_test_REPLACE_WITH_YOUR_STRIPE_KEY"
    echo -e "${YELLOW}âš ï¸  Remember to add Stripe key later!${NC}"
fi

# Create .env.production
cat > .env.production << EOF
# ================================================================
# HOUSE OF JAZZU HQ - Production Environment
# Generated: $(date)
# ================================================================

# ===== CORE AUTHENTICATION =====
VAULT_MASTER_KEY=$VAULT_KEY
SPECIAL_PASSWORD=AddieMaeLeSane33

# ===== TELEGRAM (âœ… CONFIGURED) =====
TELEGRAM_BOT_TOKEN=8527180311:AAELzHU-XcpeQe9ghCPuk2c7lGRm1I0K-rw
TELEGRAM_CHAT_ID=7990584719
TELEGRAM_WEBHOOK_URL=https://$DOMAIN/api/telegram/webhook

# ===== DATABASE =====
POSTGRES_PASSWORD=$POSTGRES_PASSWORD
REDIS_PASSWORD=$REDIS_PASSWORD
DATABASE_URL=postgresql://jazzu:$POSTGRES_PASSWORD@postgres:5432/jazzu_hq
REDIS_URL=redis://:$REDIS_PASSWORD@redis:6379

# ===== STRIPE =====
STRIPE_SECRET_KEY=$STRIPE_KEY
STRIPE_PUBLISHABLE_KEY=pk_test_REPLACE_WITH_YOUR_KEY
STRIPE_WEBHOOK_SECRET=whsec_REPLACE_AFTER_WEBHOOK_SETUP

# ===== DOMAIN =====
DOMAIN=$DOMAIN
API_URL=https://$DOMAIN
NEXT_PUBLIC_API_URL=https://$DOMAIN/api
NEXT_PUBLIC_SAVON_WSS_URL=wss://$DOMAIN/telemetry
CORS_ORIGINS=https://$DOMAIN,https://www.$DOMAIN

# ===== MONITORING =====
GRAFANA_PASSWORD=$GRAFANA_PASSWORD

# ===== SECURITY =====
SESSION_TIMEOUT=86400
MAX_LOGIN_ATTEMPTS=5
LOCKOUT_DURATION=900
HTTPS_ONLY=true
SECURE_COOKIES=true
RATE_LIMIT_PER_MINUTE=60
RATE_LIMIT_PER_HOUR=1000

# ===== APPLICATION =====
NODE_ENV=production
PYTHON_ENV=production
DEBUG=false
LOG_LEVEL=info
WORKERS=4
MAX_REQUEST_SIZE=10485760
REQUEST_TIMEOUT=30

# ===== VECTOR DATABASE =====
UNIBASE_URL=http://unibase:8002
UNIBASE_DATA_PATH=/data
EMBEDDING_MODEL=text-embedding-3-small

# ===== AGENTS =====
ENABLE_NIA=true
ENABLE_SAVON=true
ENABLE_KANO=true
NIA_MAX_PLANNING_STEPS=10
NIA_CONFIDENCE_THRESHOLD=0.7
KANO_AUTO_LOCK_ENABLED=true

# ===== FEATURES =====
ENABLE_QUANTUM=true
ENABLE_TAX_RITUAL=true
ENABLE_TELEGRAM=true
ENABLE_STRIPE=true

# ===== TAX =====
TAX_YEAR=2026
MARGINAL_TAX_RATE=0.24
STATE_TAX_RATE=0.05
SE_TAX_RATE=0.153

# ===== RITUALS =====
MAX_RITUALS_FREE=10
MAX_RITUALS_PAID=100
QUANTUM_SEED_MIN=1
QUANTUM_SEED_MAX=1000000
RITUAL_TIMEOUT=30

# ===== BACKUP =====
BACKUP_DIR=/home/jazzu/backups
BACKUP_SCHEDULE=0 2 * * *
BACKUP_RETENTION=30
ENCRYPT_BACKUPS=true

# ===== STORAGE =====
VAULT_PATH=/app/vault/vault.enc
LOG_DIR=/app/logs
DATA_DIR=/app/data
LOG_MAX_SIZE=100
LOG_RETENTION_DAYS=90

# ===== DOCKER =====
COMPOSE_PROJECT_NAME=jazzu
NETWORK_SUBNET=172.20.0.0/16

# ===== OPTIONAL (leave empty if not using) =====
AZURE_CLIENT_ID=
AZURE_TENANT_ID=
AZURE_SUBSCRIPTION_ID=
NVIDIA_NIM_URL=
OPENAI_API_KEY=
BRICS_PAY_API_KEY=
BTC_L2_NODE_URL=
SINGAPORE_PTC_API_KEY=
GITHUB_TOKEN=
SENDGRID_API_KEY=
SENTRY_DSN=
GA_TRACKING_ID=
EOF

echo ""
echo -e "${GREEN}âœ… Created .env.production${NC}"
echo ""

# Display summary
echo "================================================================"
echo "ðŸ“‹ CONFIGURATION SUMMARY"
echo "================================================================"
echo ""
echo -e "${BLUE}Domain:${NC} $DOMAIN"
echo -e "${BLUE}Telegram Bot:${NC} âœ… Configured (ID: 7990584719)"
echo -e "${BLUE}Vault Master Key:${NC} âœ… Generated (32 bytes)"
echo -e "${BLUE}Database Passwords:${NC} âœ… Generated"
echo -e "${BLUE}Monitoring Password:${NC} âœ… Generated"
echo ""

if [ "$STRIPE_KEY" = "sk_test_REPLACE_WITH_YOUR_STRIPE_KEY" ]; then
    echo -e "${YELLOW}âš ï¸  TODO: Add Stripe API key to .env.production${NC}"
else
    echo -e "${GREEN}âœ… Stripe configured (test mode)${NC}"
fi

echo ""
echo "================================================================"
echo "ðŸš€ NEXT STEPS"
echo "================================================================"
echo ""
echo "1. Review .env.production and add any optional keys"
echo ""
echo "2. If you haven't already, get Stripe keys:"
echo "   https://dashboard.stripe.com/test/apikeys"
echo ""
echo "3. Deploy to VPS:"
echo "   scp .env.production jazzu@YOUR_VPS_IP:~/house-of-jazzu-hq/"
echo ""
echo "4. On VPS, start services:"
echo "   docker-compose up -d --build"
echo ""
echo "5. Setup Telegram webhook after deployment:"
echo "   curl -F \"url=https://$DOMAIN/api/telegram/webhook\" \\"
echo "     https://api.telegram.org/bot8527180311:AAELzHU-XcpeQe9ghCPuk2c7lGRm1I0K-rw/setWebhook"
echo ""
echo "6. Setup Stripe webhook:"
echo "   Go to: https://dashboard.stripe.com/webhooks"
echo "   URL: https://$DOMAIN/api/webhooks/stripe"
echo "   Events: payment_intent.succeeded, customer.subscription.*"
echo ""
echo "7. Test your deployment:"
echo "   curl https://$DOMAIN/health"
echo "   open https://$DOMAIN"
echo ""
echo "================================================================"
echo ""
echo -e "${GREEN}ðŸŽ‰ Setup complete! Ready to deploy.${NC}"
echo ""
echo -e "${RED}âš ï¸  IMPORTANT: Never commit .env.production to Git!${NC}"
echo ""

# Create .gitignore if it doesn't exist
if [ ! -f .gitignore ]; then
    cat > .gitignore << 'GITIGNORE'
# Environment files
.env
.env.production
.env.local
.env.*.local

# Dependencies
node_modules/
__pycache__/
*.pyc

# Build outputs
.next/
dist/
build/
out/

# Logs
logs/
*.log

# OS files
.DS_Store
Thumbs.db

# IDE
.vscode/
.idea/
*.swp

# Secrets
*.pem
*.key
secrets/

# Data
data/
vault/
backups/

# Docker
docker-compose.override.yml
GITIGNORE
    echo -e "${GREEN}âœ… Created .gitignore${NC}"
fi

# Create quick test script
cat > test-telegram.sh << 'TESTSCRIPT'
#!/bin/bash
# Quick test to send Telegram notification

BOT_TOKEN="8527180311:AAELzHU-XcpeQe9ghCPuk2c7lGRm1I0K-rw"
CHAT_ID="7990584719"
MESSAGE="ðŸ›ï¸ House of Jazzu HQ is online! System test successful."

curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
  -d chat_id="${CHAT_ID}" \
  -d text="${MESSAGE}" \
  -d parse_mode="Markdown"

echo ""
echo "âœ… Test message sent! Check your Telegram."
TESTSCRIPT

chmod +x test-telegram.sh

echo ""
echo -e "${BLUE}ðŸ’¬ Test Telegram now:${NC} ./test-telegram.sh"
echo ""
