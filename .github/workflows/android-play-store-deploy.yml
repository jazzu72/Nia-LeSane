name: Android Play Store Deploy

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:
        inputs:
            track:
                description: "Release track"
                required: true
                default: "beta"
                type: choice
                options:
                    - internal
                    - alpha
                    - beta
                    - production

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-java@v3
              with:
                  java-version: 17
                  distribution: "temurin"
                  cache: gradle

            - name: Decode Secrets
              run: |
                  echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
                  echo "${{ secrets.GOOGLE_PLAY_JSON_BASE64 }}" | base64 -d > play-key.json

            - name: Build Release Bundle
              run: |
                  chmod +x gradlew
                  ./gradlew bundleRelease \
                    -Pandroid.injected.signing.store.file=$(pwd)/keystore.jks \
                    -Pandroid.injected.signing.store.password="${{ secrets.KEYSTORE_PASSWORD }}" \
                    -Pandroid.injected.signing.key.alias="${{ secrets.KEY_ALIAS }}" \
                    -Pandroid.injected.signing.key.password="${{ secrets.KEY_PASSWORD }}"

            - name: Upload to Play Store
              uses: r0adkll/upload-google-play@v1
              with:
                  serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_JSON_BASE64 }}
                  packageName: com.houseofjazzu.nialesane
                  releaseFiles: "app/build/outputs/bundle/release/*.aab"
                  track: ${{ github.event.inputs.track || 'beta' }}
                  status: "draft"

            - name: Notify Success
              uses: 8398a7/action-slack@v3
              if: success()
              with:
                  status: custom
                  custom_payload: |
                      {
                        text: 'âœ… Android deployment successful - ${{ github.ref_name }}'
                      }
                  webhook_url: ${{ secrets.SLACK_WEBHOOK }}
