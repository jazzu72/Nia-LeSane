name: iOS App Store Deploy

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        type: string

env:
  XCODE_VERSION: 15.1
  FASTLANE_VERSION: 2.220.0

permissions:
  contents: write
  deployments: write

jobs:
  validate:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate version tag format
        run: |
          VERSION_TAG="${{ github.ref }}"
          if [[ ! $VERSION_TAG =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version tag format: $VERSION_TAG"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "✅ Version tag is valid: $VERSION_TAG"

  build-and-deploy:
    runs-on: macos-latest
    needs: validate
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
          xcode-select -p
          xcodebuild -version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.0
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install bundler
          bundle install --gemfile=./ios/Gemfile
          bundle exec fastlane -v

      - name: Verify Secrets
        run: |
          if [ -z "${{ secrets.APPLE_ID_EMAIL }}" ]; then
            echo "❌ Missing secret: APPLE_ID_EMAIL"
            exit 1
          fi
          if [ -z "${{ secrets.APPLE_AUTH_KEY }}" ]; then
            echo "❌ Missing secret: APPLE_AUTH_KEY"
            exit 1
          fi
          if [ -z "${{ secrets.IOS_PROVISIONING_PROFILE }}" ]; then
            echo "❌ Missing secret: IOS_PROVISIONING_PROFILE"
            exit 1
          fi
          echo "✅ All required secrets are configured"

      - name: Decrypt Secrets
        run: |
          set -e
          echo "${{ secrets.APPLE_AUTH_KEY }}" | base64 -d > AuthKey.p8
          chmod 600 AuthKey.p8
          echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 -d > profile.mobileprovision
          chmod 600 profile.mobileprovision
          echo "✅ Secrets decrypted successfully"

      - name: Build iOS App
        run: |
          cd ios
          bundle exec fastlane ios build_release \
            --verbose
        env:
          FASTLANE_USER: ${{ secrets.APPLE_ID_EMAIL }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      - name: Upload to TestFlight
        run: |
          cd ios
          bundle exec fastlane ios upload_testflight \
            --verbose
        env:
          FASTLANE_USER: ${{ secrets.APPLE_ID_EMAIL }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref }}
          name: "Release ${{ github.ref }}"
          draft: false
          prerelease: false
          bodyFile: RELEASE_NOTES.md
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Deployment Status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            iOS deployment to App Store: ${{ job.status }}
            Version: ${{ github.ref }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author

      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f AuthKey.p8
          rm -f profile.mobileprovision
          echo "✅ Secrets cleaned up"
