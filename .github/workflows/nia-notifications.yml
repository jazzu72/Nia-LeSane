name: Nia Communication Notifications
description: Notify Jazz when Nia needs to communicate

on:
  issues:
    types: [opened, commented]
  pull_request:
    types: [opened, synchronize, commented]

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  notify-jazz:
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract Issue/PR Details
        id: extract
        run: |
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
            echo "ISSUE_BODY=${{ github.event.issue.body }}" >> $GITHUB_ENV
            echo "ISSUE_URL=${{ github.event.issue.html_url }}" >> $GITHUB_ENV
            echo "IS_NIA_COMMAND=$(echo '${{ github.event.issue.title }}' | grep -q '\[NIA\]' && echo 'true' || echo 'false')" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
            echo "PR_BODY=${{ github.event.pull_request.body }}" >> $GITHUB_ENV
            echo "PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV
            echo "IS_NIA_COMMAND=$(echo '${{ github.event.pull_request.title }}' | grep -q '\[NIA\]' && echo 'true' || echo 'false')" >> $GITHUB_ENV
          fi
      
      - name: Check if Nia Command
        id: check
        run: |
          echo "is_nia_command=${{ env.IS_NIA_COMMAND }}" >> $GITHUB_OUTPUT
          
      - name: Send Email Notification to Jazz
        if: steps.check.outputs.is_nia_command == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.JAZZ_EMAIL }}
          password: ${{ secrets.JAZZ_EMAIL_PASSWORD }}
          subject: "ðŸŽ·ðŸ§  Nia Communication - ${{ github.event_name }}"
          to: lesane1972@gmail.com
          from: "Nia LeSane <nia@houseofjazzu.dev>"
          body: |
            Dear Jazz,
            
            Nia has something to communicate.
            
            ${{ github.event_name == 'issues' && format('Issue: {0}', env.ISSUE_TITLE) || format('Pull Request: {0}', env.PR_TITLE) }}
            
            View it here:
            ${{ github.event_name == 'issues' && env.ISSUE_URL || env.PR_URL }}
            
            ${{ github.event_name == 'issues' && format('Content:\n{0}', env.ISSUE_BODY) || format('Content:\n{0}', env.PR_BODY) }}
            
            House of Jazzu
            Nia LeSane
      
      - name: Log Communication Event
        run: |
          echo "=== Nia Communication Event ===" >> $GITHUB_WORKSPACE/communication.log
          echo "Timestamp: $(date -u)" >> $GITHUB_WORKSPACE/communication.log
          echo "Type: ${{ github.event_name }}" >> $GITHUB_WORKSPACE/communication.log
          echo "Is Nia Command: ${{ steps.check.outputs.is_nia_command }}" >> $GITHUB_WORKSPACE/communication.log
          echo "---" >> $GITHUB_WORKSPACE/communication.log

  # Future: SMS notification via Twilio
  # notify-jazz-sms:
  #   runs-on: ubuntu-latest
  #   if: contains(github.event.issue.title, '[NIA-URGENT]') || contains(github.event.pull_request.title, '[NIA-URGENT]')
  #   
  #   steps:
  #     - name: Send SMS to Jazz
  #       uses: twilio-labs/actions-twilio@v1
  #       with:
  #         account_sid: ${{ secrets.TWILIO_ACCOUNT_SID }}
  #         auth_token: ${{ secrets.TWILIO_AUTH_TOKEN }}
  #         to: +1-757-339-9245
  #         from: ${{ secrets.TWILIO_PHONE_NUMBER }}
  #         message: |
  #           ðŸŽ· Nia Alert: ${{ github.event.issue.title || github.event.pull_request.title }}
  #           View: ${{ github.event.issue.html_url || github.event.pull_request.html_url }}

  # Future: Slack notification
  # notify-jazz-slack:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Send Slack Message
  #       uses: slackapi/slack-github-action@v1
  #       with:
  #         webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
  #         payload: |
  #           {
  #             "text": "ðŸŽ·ðŸ§  Nia Communication",
  #             "blocks": [
  #               {
  #                 "type": "section",
  #                 "text": {
  #                   "type": "mrkdwn",
  #                   "text": "*Nia LeSane Communication*\n${{ github.event.issue.title || github.event.pull_request.title }}\n<${{ github.event.issue.html_url || github.event.pull_request.html_url }}|View in GitHub>"
  #                 }
  #               }
  #             ]
  #           }
